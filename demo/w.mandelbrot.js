var h,i,j,k,l,m,n,o,p,q,r,s,t,u;function v(){var d=o+k>p?p-k:o,e;for(e=0;e<d;e++){var c=k+e,a=c%q,b=Math.floor(c/q),c=b*q+a,a=w(a,b),f=b=void 0,g=void 0,a=6*a/s;1>a?(b=255,f=255*a,g=0):2>a?(b=255*(2-a),f=255,g=0):3>a?(b=0,f=255,g=255*(a-2)):4>a?(b=0,f=255*(4-a),g=255):5>a?(b=255*(a-4),f=0,g=255):(b=255,f=0,g=255*(6-a));t[c]=-16777216|g<<16|f<<8|b}}
function w(d,e){var c,a;c=j*(l*d/q-1.75)+h;a=j/n*(m*e/r-1)+i;var b=(c-0.25)*(c-0.25)+a*a;if(c<=Math.sqrt(b)-2*b+0.25)return s;var f=b=0,g,x;for(g=0;4>b*b+f*f&&g<s;g++)x=b*b-f*f+c,f=2*b*f+a,b=x;return g}function y(d){for(var e=0,c=d.length,a=0;a<c;a++)e+=d[a];return e/c}function z(d,e){for(var c=d.length,a=0,b=0;b<c;b++)var f=d[b]-e,a=a+f*f;return Math.pow(a/c,0.5)}
self.onmessage=function(d){var e=d.data.state,c=d.data.settings;h=e.x;i=e.y;j=e.z;k=e.blockOffset;l=c.dx;m=c.dy;n=c.forcedHeight;p=o=c.totalPixels;q=c.width;r=c.height;s=c.maxIteration;u=c.minStdDev;e=d.data.buffer;t=new Uint32Array(e,0,p);switch(d.data.type){case "render":v();break;case "random":var a,b=0;do{d=[];j=1/Math.pow(2,Math.floor(22*Math.random())+10);h=l*(Math.random()-0.5);i=m*(Math.random()-0.5);for(b=0;32>b;b++)c=Math.floor(b%4*q/4),a=Math.floor(Math.floor(b/4)*r/4),d.push(w(c,a));b++}while(z(d,
y(d))<u&&100>b);v()}d={};d.imagedata=e;d.blockOffset=k;d.x=h;d.y=i;d.z=j;self.webkitPostMessage(d,[e])};
